<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>RideCam - Turn your Phone into a Dash Camera</title>
<meta name="description" content="Turn your Phone into a Dash Cam">

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<!-- FFmpeg for MP4 and GIF conversion -->
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>

<style>
body {
  margin:0; background:#000; color:#fff; font-family:Arial;
  height:100vh; overflow:hidden;
  position:relative;
}

/* NAVIGATION */
nav {
  width:100%;
  background:#111;
  padding:12px;
  text-align:center;
  position:fixed;
  top:0; left:0;
  z-index:5;
}
nav button {
  background:#222;
  border:1px solid #444;
  padding:10px 16px;
  color:white;
  margin:0 6px;
  border-radius:8px;
  font-size:18px;
  cursor:pointer;
}
nav button.active {
  background:#007bff;
}

/* MAIN WRAPPER */
#appPages {
  position:absolute;
  top:60px;
  left:0;
  width:100%;
  height:calc(100vh - 60px);
  overflow:hidden;
}

/* DASHCAM PAGE */
#dashcamPage {
  width:100%;
  height:100%;
  position:relative;
  display:flex;
  justify-content:center;
  align-items:center;
  text-align:center;
  overflow:hidden;
}

#preview {
  position:absolute;
  top:0; left:0;
  width:100%; height:100%;
  display:none;
  background:#111;
  z-index:1;
  object-fit:cover;
}

canvas {
  position: absolute;
  top:0;
  left:0;
  z-index:2;
  pointer-events:none;
}

#description {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%);
  width:85%;
  font-size:22px;
  text-align:center;
  z-index:3;
  line-height:1.4em;
}

.center-start {
  position:absolute;
  top:65%;
  left:50%;
  transform:translate(-50%, -50%);
  z-index:3;
}

button {
  padding:18px 26px;
  font-size:22px;
  border:none;
  border-radius:12px;
  background:#28a745;
  color:#fff;
  cursor:pointer;
}

#startBtn {
  padding:36px 52px;
  font-size:44px;
}

.controls {
  position: absolute;
  bottom: 36%;
  left: 50%;
  transform: translateX(-50%);
  display: none;
  gap: 16px;
  z-index: 4;
}

.controls button {
  padding:28px 44px;
  font-size:clamp(28px, 8vw, 40px);
  border-radius:16px;
}

#saveBtn { background:#007bff; color:white; }
#stopBtn { background:#dc3545; color:white; }

/* POPUP */
#formatPopup {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.75);
  z-index:9999;
  justify-content:center;
  align-items:center;
}
#formatPopup .box {
  background:#222;
  padding:25px;
  border-radius:15px;
  text-align:center;
  width:80%;
  max-width:350px;
}

#formatPopup button {
  margin:10px;
  padding:15px 25px;
  font-size:22px;
  border-radius:10px;
}

#saveWebM { background:#007bff; color:white; }
#saveMP4 { background:#ff9800; color:white; }
#saveGIF { background:#ff33cc; color:white; }
#cancelFormat { background:#555; color:white; padding:10px 16px; font-size:18px; }

</style>
</head>

<body>

<!-- NAV BAR -->
<nav>
  <button id="navDashcam" class="active">DashCam</button>
  <button id="navFAQ">FAQ</button>
  <button id="navAbout">About</button>
  <button id="navLegal">Legal</button>
  <button id="navDonations">Donations</button>
</nav>

<div id="appPages">

  <!-- DASHCAM PAGE -->
  <div id="dashcamPage" class="page" style="display:block;">
    <div id="description">
      This camera will save up to the last 5 minutes of video,<br>
      press Start to begin.
    </div>

    <button id="startBtn" class="center-start">Start</button>

    <video id="preview" autoplay playsinline muted></video>

    <div id="controls" class="controls">
      <button id="saveBtn" class="control-btn">Save Video</button>
      <button id="stopBtn" class="control-btn">Stop</button>
    </div>
  </div>

  <!-- FAQ -->
  <div id="faqPage" class="page">
    <h1>FAQ</h1>
    <div class="faq-item">
      <h3>How does this work?</h3>
      <p>
        Click Start when you're ready to start your drive.<br>
        The camera keeps the last 5 minutes.<br>
        When something happens, press <b>Save Video</b>.
      </p>
    </div>

    <div class="faq-item">
      <h3>What file format does it save in?</h3>
      <p>The camera saves in Webmedia format. You can convert the file using MP4 or GIF option.</p>
    </div>

    <div class="faq-item">
      <h3>What about IOS?</h3>
      <p>iOS cannot play WebM, but MP4 export works.</p>
    </div>

    <div class="faq-item">
      <h3>Why do you need camera access?</h3>
      <p>To function as a dash cam, camera access is required.</p>
    </div>

    <div class="faq-item">
      <h3>Do you store anything?</h3>
      <p>No. Everything stays on your device.</p>
    </div>

    <div class="faq-item">
      <h3>Why location access?</h3>
      <p>It’s used to calculate driving speed.</p>
    </div>

    <div class="faq-item">
      <h3>Screen off?</h3>
      <p>No, the camera must stay active.</p>
    </div>

  </div>

</div>

<!-- POPUP FOR SAVE FORMAT -->
<div id="formatPopup">
  <div class="box">
    <h3 style="margin-top:0;color:#fff;">Save Video As:</h3>
    <button id="saveWebM">WebM</button>
    <button id="saveMP4">MP4</button>
    <button id="saveGIF">GIF</button>
    <br><br>
    <button id="cancelFormat">Cancel</button>
  </div>
</div>

<script>
/* ---------- Navigation ---------- */
const pages = {
  dashcam: document.getElementById("dashcamPage"),
  faq: document.getElementById("faqPage")
};
const navButtons = {
  dashcam: document.getElementById("navDashcam"),
  faq: document.getElementById("navFAQ")
};

function showPage(page) {
  Object.values(pages).forEach(p => p.style.display = "none");
  Object.values(navButtons).forEach(b => b.classList.remove("active"));
  pages[page].style.display = "block";
  navButtons[page].classList.add("active");
  if (page !== "dashcam") stopCamera();
}

/* ---------- Dashcam ---------- */
let stream, recorder;
let buffer = [];
const maxChunks = 60;
const preview = document.getElementById("preview");
const startBtn = document.getElementById("startBtn");
const controls = document.getElementById("controls");
const saveBtn = document.getElementById("saveBtn");
const stopBtn = document.getElementById("stopBtn");

/* Overlay canvas */
let mimeType = "";
let drawing = false;

const overlayCanvas = document.createElement("canvas");
overlayCanvas.style.display = "none";
document.body.appendChild(overlayCanvas);
const ctx = overlayCanvas.getContext("2d");

function resizeCanvas() {
  const rect = preview.getBoundingClientRect();
  overlayCanvas.width = rect.width || window.innerWidth;
  overlayCanvas.height = rect.height || (window.innerHeight - 60);
  overlayCanvas.style.left = rect.left + "px";
  overlayCanvas.style.top = rect.top + "px";
}

preview.addEventListener("loadedmetadata", () => setTimeout(resizeCanvas, 120));
window.addEventListener("resize", () => setTimeout(resizeCanvas, 120));

let speedKmh = 0;

function drawOverlay() {
  if (!drawing) return;
  ctx.clearRect(0,0,overlayCanvas.width, overlayCanvas.height);
  ctx.drawImage(preview, 0, 0, overlayCanvas.width, overlayCanvas.height);

  ctx.font = "20px Arial";
  ctx.fillStyle = "yellow";
  ctx.fillText(new Date().toLocaleString(), 20, 20);
  ctx.fillText(`Speed: ${speedKmh.toFixed(1)} km/h`, 20, 50);

  requestAnimationFrame(drawOverlay);
}

async function startRecording() {
  try {
    mimeType = "video/webm";
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode:"environment" },
      audio: false
    });

    preview.srcObject = stream;
    preview.style.display = "block";
    startBtn.style.display = "none";
    controls.style.display = "flex";
    overlayCanvas.style.display = "block";

    drawing = true;
    drawOverlay();

    const combinedStream = overlayCanvas.captureStream(30);
    stream.getTracks().forEach(t => combinedStream.addTrack(t));

    buffer = [];
    recorder = new MediaRecorder(combinedStream, { mimeType });

    recorder.ondataavailable = (e) => {
      if (e.data.size > 0) {
        buffer.push(e.data);
        if (buffer.length > maxChunks) buffer.shift();
      }
    };

    recorder.start(500);
  } catch (err) {
    alert("Camera error: " + err);
  }
}

startBtn.onclick = startRecording;

/* ---------- Save Video → Popup ---------- */
const popup = document.getElementById("formatPopup");
const saveWebM = document.getElementById("saveWebM");
const saveMP4 = document.getElementById("saveMP4");
const saveGIF = document.getElementById("saveGIF");
const cancelFormat = document.getElementById("cancelFormat");
const box = popup.querySelector(".box");

saveBtn.onclick = () => {
  if (buffer.length === 0) return alert("No video yet.");
  popup.style.display = "flex";
};

cancelFormat.onclick = () => popup.style.display = "none";

/* ---------- Save WebM ---------- */
saveWebM.onclick = () => {
  const blob = new Blob(buffer, { type: mimeType });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `dashcam_${new Date().toISOString()}.webm`;
  a.click();
  popup.style.display = "none";
};

/* ---------- Save MP4 ---------- */
saveMP4.onclick = async () => {
  const original = box.innerHTML;
  box.innerHTML = "<h3 style='color:white;'>Converting to MP4... Please wait</h3>";

  const blob = new Blob(buffer, { type: mimeType });
  const uint8 = new Uint8Array(await blob.arrayBuffer());

  const { createFFmpeg } = FFmpeg;
  const ffmpeg = createFFmpeg({ log: false });

  try {
    await ffmpeg.load();
    ffmpeg.FS("writeFile", "input.webm", uint8);

    await ffmpeg.run(
      "-i", "input.webm",
      "-c:v", "libx264",
      "-preset", "veryfast",
      "-movflags", "faststart",
      "output.mp4"
    );

    const data = ffmpeg.FS("readFile", "output.mp4");
    const mp4Blob = new Blob([data.buffer], { type: "video/mp4" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(mp4Blob);
    a.download = `dashcam_${new Date().toISOString()}.mp4`;
    a.click();
  } catch (err) {
    alert("MP4 conversion failed.");
  }

  box.innerHTML = original;
  popup.style.display = "none";
};

/* ---------- Save GIF ---------- */
saveGIF.onclick = async () => {
  const original = box.innerHTML;
  box.innerHTML = "<h3 style='color:white;'>Converting to GIF... Please wait</h3>";

  const blob = new Blob(buffer, { type: mimeType });
  const uint8 = new Uint8Array(await blob.arrayBuffer());

  const { createFFmpeg } = FFmpeg;
  const ffmpeg = createFFmpeg({ log: false });

  try {
    await ffmpeg.load();
    ffmpeg.FS("writeFile", "input.webm", uint8);

    // Create palette for high quality GIF
    await ffmpeg.run(
      "-i", "input.webm",
      "-vf", "fps=10,scale=iw:-1:flags=lanczos,palettegen",
      "palette.png"
    );

    await ffmpeg.run(
      "-i", "input.webm",
      "-i", "palette.png",
      "-lavfi", "fps=10,scale=iw:-1:flags=lanczos[p];[p][1:v]paletteuse",
      "output.gif"
    );

    const data = ffmpeg.FS("readFile", "output.gif");
    const gifBlob = new Blob([data.buffer], { type: "image/gif" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(gifBlob);
    a.download = `dashcam_${new Date().toISOString()}.gif`;
    a.click();
  } catch (err) {
    alert("GIF conversion failed.");
  }

  box.innerHTML = original;
  popup.style.display = "none";
};

/* ---------- Stop ---------- */
function stopCamera() {
  drawing = false;
  overlayCanvas.style.display = "none";
  if (recorder) recorder.stop();
  if (stream) stream.getTracks().forEach(t => t.stop());
  preview.style.display = "none";
  controls.style.display = "none";
  startBtn.style.display = "block";
}

stopBtn.onclick = stopCamera;

</script>
</body>
</html>
