<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>DashCam</title>

<!-- Disable ALL caching -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
body {
  margin:0; background:#000; color:#fff; font-family:Arial;
  display:flex; justify-content:center; align-items:center;
  height:100vh; overflow:hidden;
  position:relative;
  text-align:center;
}

/* Video behind UI */
#preview {
  position:absolute; top:0; left:0;
  width:100%; height:auto;
  display:none; background:#111;
  z-index:1;
}

/* Overlay canvas above video but under buttons */
canvas {
  position:absolute;
  top:0; left:0;
  z-index:2;
  pointer-events:none; /* allow touches through canvas */
}

/* Description text above Start button */
#description {
  position:absolute;
  top:35%;
  left:50%;
  transform:translateX(-50%);
  width:90%;
  font-size:20px;
  color:#fff;
  z-index:3;
}

/* Start button */
.center-start {
  position:absolute;
  top:50%; left:50%;
  transform:translate(-50%, -50%);
  z-index:3;
}

button {
  padding:18px 26px;
  font-size:22px;
  border:none;
  border-radius:12px;
  background:#28a745;
  color:#fff;
  cursor:pointer;
}

/* Controls row */
.controls {
  position:absolute;
  bottom:10vh;               /* moved higher to avoid being cut off */
  left:50%;
  transform:translateX(-50%);
  width:90%;
  display:flex;
  justify-content:center;
  gap:14px;
  display:none;
  z-index:3;
}

.control-btn {
  padding:20px 28px;
  font-size:22px;
  border:none;
  border-radius:14px;
  cursor:pointer;
}

#saveBtn { background:#007bff; color:white; }
#stopBtn { background:#dc3545; color:white; }

/* Small screen adjustments */
@media(max-width:480px){
  .control-btn, button{
    padding:16px 22px;
    font-size:18px;
  }

  #description {
    font-size:16px;
  }
}

/* Extra safety for very short screens */
@media(max-height:700px){
  .controls {
    bottom:12vh;
  }
}
</style>
</head>

<body>

<div id="description">
  This camera will save up to the last 5 minutes of video, press Start to begin.
</div>
<button id="startBtn" class="center-start">Start</button>

<video id="preview" autoplay playsinline muted></video>

<div id="controls" class="controls">
  <button id="saveBtn" class="control-btn">Save Video</button>
  <button id="stopBtn" class="control-btn">Stop</button>
</div>

<script>
let stream, recorder;
let buffer = [];
const maxChunks = 60;
const preview = document.getElementById("preview");
const startBtn = document.getElementById("startBtn");
const controls = document.getElementById("controls");
const saveBtn = document.getElementById("saveBtn");
const stopBtn = document.getElementById("stopBtn");
const description = document.getElementById("description");

let mimeType = "";
let drawing = false;

// Overlay canvas
const overlayCanvas = document.createElement("canvas");
overlayCanvas.style.display = "none";
document.body.appendChild(overlayCanvas);

const ctx = overlayCanvas.getContext("2d");

function pickMimeType() {
  const options = [
    "video/webm;codecs=vp9",
    "video/webm;codecs=vp8",
    "video/webm",
    "video/mp4"
  ];
  for (let type of options) {
    if (MediaRecorder.isTypeSupported(type)) return type;
  }
  return "video/webm";
}

function resizeCanvas() {
  overlayCanvas.width = preview.videoWidth || window.innerWidth;
  overlayCanvas.height = preview.videoHeight || window.innerHeight;
}
preview.addEventListener("loadedmetadata", resizeCanvas);
window.addEventListener("resize", resizeCanvas);

let lastPosition = null;
let speedKmh = 0;

function drawOverlay() {
  if (!drawing) return;

  ctx.drawImage(preview, 0, 0, overlayCanvas.width, overlayCanvas.height);

  ctx.font = "26px Arial";
  ctx.fillStyle = "yellow";
  ctx.fillText(new Date().toLocaleString(), 12, 40);
  ctx.fillText(`Speed: ${speedKmh.toFixed(1)} km/h`, 12, 80);

  requestAnimationFrame(drawOverlay);
}

function watchSpeed() {
  if (!navigator.geolocation) return;
  navigator.geolocation.watchPosition(
    (pos) => {
      const { latitude, longitude } = pos.coords;
      const now = pos.timestamp;

      if (lastPosition) {
        const R = 6371e3;
        const toRad = v=>v*Math.PI/180;
        const dLat = toRad(latitude - lastPosition.lat);
        const dLon = toRad(longitude - lastPosition.lon);

        const a =
          Math.sin(dLat/2)**2 +
          Math.cos(toRad(lastPosition.lat)) *
          Math.cos(toRad(latitude)) *
          Math.sin(dLon/2)**2;

        const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = R*c;
        const dt = (now - lastPosition.time)/1000;

        if (dt > 0) speedKmh = (distance/dt) * 3.6;
      }

      lastPosition = { lat: latitude, lon: longitude, time: now };
    },
    (err)=>console.warn(err),
    { enableHighAccuracy:true, maximumAge:1000, timeout:5000 }
  );
}

async function startRecording() {
  try {
    mimeType = pickMimeType();

    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode:"environment" },
      audio: false
    });

    preview.srcObject = stream;
    preview.style.display = "block";
    startBtn.style.display = "none";
    description.style.display = "none"; // hide description when recording
    controls.style.display = "flex";
    overlayCanvas.style.display = "block";

    drawing = true;
    drawOverlay();
    watchSpeed();

    const combinedStream = overlayCanvas.captureStream(30);
    stream.getTracks().forEach(t => combinedStream.addTrack(t));

    buffer = [];
    recorder = new MediaRecorder(combinedStream, { mimeType });

    recorder.ondataavailable = (e) => {
      if (e.data.size > 0) {
        buffer.push(e.data);
        if (buffer.length > maxChunks) buffer.shift();
      }
    };

    recorder.start(5000);

  } catch (err) {
    alert("Camera access failed. Try tapping Start again.\n" + err);
  }
}

startBtn.addEventListener("click", startRecording);

// Save last 5 minutes
saveBtn.addEventListener("click", () => {
  if (buffer.length === 0) {
    alert("No video recorded yet.");
    return;
  }

  const blob = new Blob(buffer, { type: mimeType });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  let ext = mimeType.includes("mp4") ? "mp4" : "webm";
  a.download = `dashcam_${new Date().toISOString()}.${ext}`;
  a.click();
});

// Stop button
stopBtn.addEventListener("click", () => {
  drawing = false;
  overlayCanvas.style.display = "none";
  speedKmh = 0;

  if (recorder) recorder.stop();
  if (stream) stream.getTracks().forEach(t => t.stop());

  preview.style.display = "none";
  controls.style.display = "none";
  startBtn.style.display = "block";
  description.style.display = "block"; // show description again
});
</script>

</body>
</html>
